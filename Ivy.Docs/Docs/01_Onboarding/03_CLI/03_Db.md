# Ivy Database Integration

The `ivy db` commands allow you to add and manage database connections in your Ivy project. Ivy supports a wide range of database providers and automatically generates the necessary Entity Framework configurations.

## Supported Database Providers

Ivy supports the following database providers:

### Relational Databases

- **SQL Server** - Microsoft's enterprise database
- **PostgreSQL** - Advanced open-source database
- **MySQL** - Popular open-source database
- **MariaDB** - MySQL fork with enhanced features
- **SQLite** - Lightweight file-based database
- **Oracle** - Enterprise database system

### Cloud Databases

- **Supabase** - Open-source Firebase alternative with PostgreSQL
- **Google Spanner** - Globally distributed database
- **Snowflake** - Cloud data platform

### Specialized Databases

- **ClickHouse** - Column-oriented database for analytics
- **Airtable** - Spreadsheet-database hybrid

## Basic Usage

### Adding a Database Connection

```terminal
>ivy db add
```

This command will:

- Prompt you to select a database provider
- Ask for a connection name
- Generate the necessary Entity Framework configuration
- Set up connection strings and secrets management

### Generating Database Context

```terminal
>ivy db generate
```

Generate Entity Framework DbContext and migrations for your database connections.

## Command Options

### `ivy db add` Options

#### `--provider <PROVIDER>`

Specify the database provider directly:

```terminal
>ivy db add --provider Postgres
```

Available providers: `SqlServer`, `Postgres`, `MySql`, `MariaDb`, `Sqlite`, `Supabase`, `Airtable`, `Oracle`, `Spanner`, `ClickHouse`, `Snowflake`

#### `--name <CONNECTION_NAME>`

Specify the connection name in PascalCase:

```terminal
>ivy db add --name MyDatabase
```

#### `--connection-string <CONNECTION_STRING>`

Provide the connection string directly:

```terminal
>ivy db add --provider Postgres --connection-string YourConnectionString
```

#### `--schema <SCHEMA>`

Specify the database schema (for providers that support it):

```terminal
>ivy db add --provider Postgres --schema public
```

#### `--verbose`

Enable verbose output for detailed logging:

```terminal
>ivy db add --verbose
```

## Interactive Mode

When you run `ivy db add` without specifying options, Ivy will guide you through an interactive setup:

1. **Select Database Provider**: Choose from the available providers
2. **Connection Name**: Enter a name for your connection (PascalCase recommended)
3. **Connection String**: Provide the connection string or let Ivy help you build it

## Connection Management

### Connection Structure

Each database connection creates a folder structure:

```text
Connections/
└── [ConnectionName]/
    ├── DbContext.cs          # Entity Framework DbContext
    ├── DbContextFactory.cs   # DbContext factory
    ├── Connection.cs         # Connection configuration
    └── Migrations/           # Entity Framework migrations
```

### Connection Configuration

Ivy automatically configures:

- **Entity Framework Core** with the appropriate provider
- **Connection strings** stored securely using .NET User Secrets
- **DbContext** with proper configuration
- **Migrations** for database schema management

## Database-Specific Configuration

### SQL Server

```terminal
>ivy db add --provider SqlServer --name MySqlServer
```

**Connection String Format:**
```text
Server=localhost;Database=mydb;Trusted_Connection=true;
```

### PostgreSQL

```terminal
>ivy db add --provider Postgres --name MyPostgres
```

**Connection String Format:**

```text
Host=localhost;Database=mydb;Username=user;Password=pass
```

### MySQL/MariaDB

```terminal
>ivy db add --provider MySql --name MyMySql
```

**Connection String Format:**

```text
Server=localhost;Database=mydb;Uid=user;Pwd=pass
```

### SQLite

```terminal
>ivy db add --provider Sqlite --name MySqlite
```

**Connection String Format:**

```text
Data Source=app.db
```

### Supabase

```terminal
>ivy db add --provider Supabase --name MySupabase
```

**Connection String Format:**

```text
Host=your-project.supabase.co;Database=postgres;Username=postgres;Password=your-password
```

## Security and Secrets Management

Ivy automatically configures .NET User Secrets for secure connection string storage:

```terminal
>dotnet user-secrets list
```

### Environment Variables

You can also use environment variables for connection strings:

```text
export ConnectionStrings__MyDatabase="Host=localhost;Database=mydb;Username=user;Password=pass"
```

## Entity Framework Integration

### Generated DbContext

Ivy generates a DbContext for each connection:

```csharp
public partial class MyDatabaseContext : DbContext
{
    public MyDatabaseContext(DbContextOptions<MyDatabaseContext> options)
        : base(options)
    {
    }

    protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
    {
        if (!optionsBuilder.IsConfigured)
        {
            // Configuration from connection string
        }
    }
}
```

### DbContext Factory

A factory is also generated for dependency injection:

```csharp
public partial class MyDatabaseContextFactory : IDesignTimeDbContextFactory<MyDatabaseContext>
{
    public MyDatabaseContext CreateDbContext(string[] args)
    {
        var optionsBuilder = new DbContextOptionsBuilder<MyDatabaseContext>();
        // Configuration logic
        return new MyDatabaseContext(optionsBuilder.Options);
    }
}
```

## Migrations

### Creating Migrations

After adding a database connection, create initial migrations:

```terminal
>dotnet ef migrations add InitialCreate --context MyDatabaseContext
```

### Applying Migrations

Apply migrations to update your database schema:

```terminal
>dotnet ef database update --context MyDatabaseContext
```

## Program.cs Integration

Ivy automatically updates your `Program.cs` to include the database context:

```csharp
var builder = WebApplication.CreateBuilder(args);

// Add database context
builder.Services.AddDbContext<MyDatabaseContext>(options =>
    options.UseNpgsql(builder.Configuration.GetConnectionString("MyDatabase")));

// Add Ivy services
builder.Services.AddIvy();

var app = builder.Build();
app.UseIvy();
app.Run();
```

## Multiple Database Connections

You can add multiple database connections to a single project:

```terminal
>ivy db add --provider Postgres --name PrimaryDb
>ivy db add --provider Sqlite --name LogDb
>ivy db add --provider ClickHouse --name AnalyticsDb
```

## Troubleshooting

### Connection String Issues

- Ensure the connection string format is correct for your provider
- Verify database server is running and accessible
- Check firewall settings and network connectivity

### Entity Framework Issues

- Ensure required NuGet packages are installed
- Verify .NET EF tools are installed: `dotnet tool install -g dotnet-ef`
- Check for conflicting Entity Framework versions

### Authentication Issues

- Ensure you're logged in: `ivy login`
- Verify your Ivy account has the necessary permissions

## Examples

### Basic PostgreSQL Setup

```terminal
>ivy db add --provider Postgres --name MyAppDb
```

### SQL Server with Custom Schema

```terminal
>ivy db add --provider SqlServer --name InventoryDb --schema dbo
```

### Supabase Integration

```terminal
>ivy db add --provider Supabase --name UserDb
```

### Multiple Databases

```terminal
>ivy db add --provider Postgres --name PrimaryDb
>ivy db add --provider Sqlite --name LogDb
>ivy db add --provider ClickHouse --name AnalyticsDb
```

## Related Commands

- `ivy init` - Initialize a new Ivy project
- `ivy auth add` - Add authentication providers
- `ivy app create` - Create applications
- `ivy deploy` - Deploy your application 